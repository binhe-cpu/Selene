name: Sync Upstream Releases

on:
  workflow_dispatch: {}
  schedule:
    - cron: '0 */6 * * *'

concurrency:
  group: sync-upstream-releases
  cancel-in-progress: false

# æ˜¾å¼è®¾ç½®æƒé™
permissions:
  contents: write
  actions: read
  checks: read

jobs:
  sync-releases:
    runs-on: ubuntu-latest
    env:
      UPSTREAM_OWNER: MoonTechLab
      UPSTREAM_REPO: Selene
      PER_PAGE: "100"
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl

      - name: Debug - Check permissions
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== æ£€æŸ¥ GITHUB_TOKEN æƒé™ ==="
          response=$(curl -s -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}")
          echo "ä»“åº“æƒé™ä¿¡æ¯:"
          echo "$response" | jq '.permissions'
          echo "ä»¤ç‰Œæƒé™èŒƒå›´:"
          curl -s -H "Authorization: token $GH_TOKEN" https://api.github.com/user | jq '.'

      - name: Sync upstream releases
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          set -euxo pipefail

          UPSTREAM="${UPSTREAM_OWNER}/${UPSTREAM_REPO}"
          echo "=== å¼€å§‹ä» $UPSTREAM åŒæ­¥åˆ° ${GITHUB_REPOSITORY} ==="

          # é¦–å…ˆæ£€æŸ¥ä¸Šæ¸¸ä»“åº“æ˜¯å¦å­˜åœ¨ä¸”æœ‰ releases
          echo "æ£€æŸ¥ä¸Šæ¸¸ä»“åº“çŠ¶æ€..."
          upstream_info=$(curl -s -w "%{http_code}" -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/repos/${UPSTREAM_OWNER}/${UPSTREAM_REPO}")
          
          upstream_status=$(echo "$upstream_info" | tail -n1)
          upstream_content=$(echo "$upstream_info" | head -n -1)
          
          if [ "$upstream_status" -ne 200 ]; then
            echo "é”™è¯¯: æ— æ³•è®¿é—®ä¸Šæ¸¸ä»“åº“ $UPSTREAM (HTTP $upstream_status)"
            echo "å“åº”: $upstream_content"
            exit 1
          fi

          upstream_name=$(echo "$upstream_content" | jq -r '.full_name')
          releases_count=$(echo "$upstream_content" | jq -r '.releases_count // 0')
          echo "âœ“ ä¸Šæ¸¸ä»“åº“: $upstream_name"
          echo "âœ“ å‘å¸ƒæ•°é‡: $releases_count"

          mkdir -p upstream-assets

          page=1
          total_processed=0
          total_created=0
          total_skipped=0

          while true; do
            echo "=== è·å–ç¬¬ $page é¡µ releases ==="
            response=$(curl -s -w "%{http_code}" -H "Authorization: token $GH_TOKEN" \
              "https://api.github.com/repos/${UPSTREAM_OWNER}/${UPSTREAM_REPO}/releases?per_page=${PER_PAGE}&page=${page}")
            
            status_code=$(echo "$response" | tail -n1)
            releases_content=$(echo "$response" | head -n -1)
            
            if [ "$status_code" -ne 200 ]; then
              echo "é”™è¯¯: è·å– releases å¤±è´¥ (HTTP $status_code)"
              echo "å“åº”: $releases_content"
              exit 1
            fi

            # æ£€æŸ¥æ˜¯å¦ä¸ºç©ºæ•°ç»„æˆ–æ— æ•ˆå“åº”
            if ! echo "$releases_content" | jq -e '. | type == "array"' > /dev/null; then
              echo "é”™è¯¯: æ— æ•ˆçš„ API å“åº”"
              echo "$releases_content"
              exit 1
            fi

            count=$(echo "$releases_content" | jq 'length')
            echo "ç¬¬ $page é¡µæœ‰ $count ä¸ª releases"

            if [ "$count" -eq 0 ]; then
              echo "=== æ‰€æœ‰é¡µé¢å¤„ç†å®Œæˆ ==="
              echo "æ€»è®¡å¤„ç†: $total_processed ä¸ª releases"
              echo "æ€»è®¡åˆ›å»º: $total_created ä¸ªæ–° releases"
              echo "æ€»è®¡è·³è¿‡: $total_skipped ä¸ªå·²å­˜åœ¨çš„ releases"
              break
            fi

            # ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶å¤„ç†ï¼Œé¿å…å­shellå˜é‡é—®é¢˜
            temp_file=$(mktemp)
            echo "$releases_content" | jq -c '.[]' > "$temp_file"
            
            while IFS= read -r rel; do
              [ -z "$rel" ] && continue
              
              total_processed=$((total_processed + 1))
              tag_name=$(echo "$rel" | jq -r '.tag_name')
              
              if [ -z "$tag_name" ] || [ "$tag_name" = "null" ]; then
                echo "è·³è¿‡ç©º tag çš„ release"
                continue
              fi

              release_name=$(echo "$rel" | jq -r '.name // ""')
              release_body=$(echo "$rel" | jq -r '.body // ""')
              draft=$(echo "$rel" | jq -r '.draft')
              prerelease=$(echo "$rel" | jq -r '.prerelease')
              published_at=$(echo "$rel" | jq -r '.published_at')

              echo "--- å¤„ç† release: $tag_name ($release_name) ---"
              echo "å‘å¸ƒæ—¶é—´: $published_at"
              echo "è‰ç¨¿: $draft, é¢„å‘å¸ƒ: $prerelease"

              # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
              existing_check=$(curl -s -w "%{http_code}" -H "Authorization: token $GH_TOKEN" \
                "https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/tags/${tag_name}")
              
              existing_status=$(echo "$existing_check" | tail -n1)
              existing_content=$(echo "$existing_check" | head -n -1)

              if [ "$existing_status" -eq 200 ]; then
                echo "âœ“ Release $tag_name å·²å­˜åœ¨ï¼Œè·³è¿‡"
                total_skipped=$((total_skipped + 1))
                continue
              elif [ "$existing_status" -ne 404 ]; then
                echo "? æ£€æŸ¥ $tag_name æ—¶å‡ºç°æ„å¤–çŠ¶æ€: $existing_status"
                echo "$existing_content"
              fi

              echo "â†“ ä¸‹è½½ $tag_name çš„ assets..."
              safe_dir="upstream-assets/$(echo "$tag_name" | sed 's/[^A-Za-z0-9._-]/_/g')"
              mkdir -p "$safe_dir"
              
              asset_urls=$(echo "$rel" | jq -r '.assets[]?.browser_download_url // empty')
              asset_count=0
              
              if [ -n "$asset_urls" ]; then
                echo "$asset_urls" | while read -r asset_url; do
                  if [ -n "$asset_url" ]; then
                    asset_count=$((asset_count + 1))
                    fname=$(basename "$asset_url")
                    echo "  ä¸‹è½½ [$asset_count]: $fname"
                    if curl -sL -H "Authorization: token $GH_TOKEN" -f "$asset_url" -o "${safe_dir}/${fname}"; then
                      echo "  âœ“ ä¸‹è½½æˆåŠŸ: $fname"
                    else
                      echo "  âœ— ä¸‹è½½å¤±è´¥: $fname"
                    fi
                  fi
                done
              else
                echo "  æ²¡æœ‰ assets éœ€è¦ä¸‹è½½"
              fi

              echo "åˆ›å»º release $tag_name..."
              # æ„é€  payload
              payload=$(jq -nc --arg tag "$tag_name" \
                --arg name "$release_name" \
                --arg body "$release_body" \
                --argjson draft "$draft" \
                --argjson prerelease "$prerelease" \
                '{tag_name: $tag, name: $name, body: $body, draft: $draft, prerelease: $prerelease}')

              echo "Payload: $payload"

              create_response=$(curl -s -w "%{http_code}" -H "Authorization: token $GH_TOKEN" \
                -H "Accept: application/vnd.github.v3+json" \
                -H "Content-Type: application/json" \
                -d "$payload" \
                "https://api.github.com/repos/${GITHUB_REPOSITORY}/releases")
              
              create_status=$(echo "$create_response" | tail -n1)
              create_content=$(echo "$create_response" | head -n -1)

              if [ "$create_status" -eq 201 ]; then
                total_created=$((total_created + 1))
                echo "âœ“ Release $tag_name åˆ›å»ºæˆåŠŸ"
                
                upload_url=$(echo "$create_content" | jq -r '.upload_url // ""')
                if [ -n "$upload_url" ] && [ "$upload_url" != "null" ]; then
                  echo "â†‘ ä¸Šä¼  assets..."
                  upload_endpoint_base="${upload_url%\{*\}"
                  
                  if [ -d "$safe_dir" ] && [ "$(ls -A "$safe_dir" 2>/dev/null)" ]; then
                    for f in "${safe_dir}"/*; do
                      [ -f "$f" ] || continue
                      fname=$(basename "$f")
                      echo "  ä¸Šä¼ : $fname"
                      upload_result=$(curl -s -w "%{http_code}" -H "Authorization: token $GH_TOKEN" \
                        -H "Content-Type: application/octet-stream" \
                        --data-binary @"$f" \
                        "${upload_endpoint_base}?name=${fname}")
                      
                      upload_status=$(echo "$upload_result" | tail -n1)
                      upload_content=$(echo "$upload_result" | head -n -1)
                      
                      if [ "$upload_status" -eq 201 ]; then
                        echo "  âœ“ $fname ä¸Šä¼ æˆåŠŸ"
                      else
                        echo "  âœ— $fname ä¸Šä¼ å¤±è´¥ (HTTP $upload_status)"
                        echo "  $upload_content"
                      fi
                    done
                  else
                    echo "  ! æ²¡æœ‰ assets éœ€è¦ä¸Šä¼ "
                  fi
                fi
              else
                echo "âœ— åˆ›å»º release $tag_name å¤±è´¥ (HTTP $create_status)"
                echo "é”™è¯¯ä¿¡æ¯: $create_content"
                # ç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªï¼Œä¸é€€å‡º
              fi

              echo "--- $tag_name å¤„ç†å®Œæˆ ---"
              echo ""

            done < "$temp_file"
            
            rm -f "$temp_file"
            page=$((page + 1))
          done

          echo "=== åŒæ­¥å®Œæˆ ==="
          echo "ğŸ“Š ç»Ÿè®¡ä¿¡æ¯:"
          echo "   å¤„ç†äº†: $total_processed ä¸ª releases"
          echo "   åˆ›å»ºäº†: $total_created ä¸ªæ–° releases"
          echo "   è·³è¿‡äº†: $total_skipped ä¸ªå·²å­˜åœ¨çš„ releases"
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -rf upstream-assets
